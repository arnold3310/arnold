<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¡ç›¡æ˜Ÿæ²³ - åºç«  (æµæš¢è½‰å ´ç‰ˆ)</title>
    <style>
        /* =========================================
           0. å­—é«”è¨­å®š
           ========================================= */
        @font-face {
            font-family: 'ç¦¹å«ä¹¦æ³•è¡Œä¹¦ç®€ä½“';
            src: url('ç¦¹å«ä¹¦æ³•è¡Œä¹¦ç®€ä½“.ttf') format('truetype'); 
        }
        @font-face {
            font-family: 'ç¦¹å«ä¹¦æ³•è¡Œä¹¦ç®€ä½“2';
            src: url('ç¦¹å«ä¹¦æ³•è¡Œä¹¦ç®€ä½“2.ttf') format('truetype'); 
        }

        /* =========================================
           1. åŸºç¤æ¨£å¼
           ========================================= */
        body { 
            margin: 0; background: #050505; overflow: hidden; 
            font-family: 'ç¦¹å«ä¹¦æ³•è¡Œä¹¦ç®€ä½“', 'ç¦¹å«ä¹¦æ³•è¡Œä¹¦ç®€ä½“2', 'Microsoft JhengHei', serif; 
            color: white;
            user-select: none; cursor: default;
        }

        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #020111 0%, #191621 100%);
            z-index: 0; overflow: hidden;
            transition: transform 3s cubic-bezier(0.7, 0, 0.3, 1); /* ç”¨æ–¼æ™‚å…‰è·³èºçš„ç¸®æ”¾ */
        }

        #battle-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('bgstart.jpg'); 
            background-size: cover; background-position: center;
            z-index: 5; opacity: 1; transition: opacity 1s;
        }

        .nebula-cloud {
            position: absolute; width: 100%; height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(62, 28, 168, 0.2), transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 222, 0.15), transparent 30%),
                radial-gradient(circle at 50% 50%, rgba(0, 240, 255, 0.1), transparent 50%);
            filter: blur(20px);
            animation: nebula-move 20s ease-in-out infinite alternate;
        }

        .bg-star {
            position: absolute; background: #fff; border-radius: 50%; opacity: 0.8;
            animation: twinkle var(--duration) ease-in-out infinite;
        }
        .bg-star.small { width: 1px; height: 1px; opacity: 0.5; }
        .bg-star.medium { width: 2px; height: 2px; opacity: 0.7; box-shadow: 0 0 2px #fff; }
        .bg-star.large { width: 3px; height: 3px; box-shadow: 0 0 5px #fff, 0 0 10px #00f0ff; }

        #particle-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; filter: drop-shadow(0 0 10px rgba(232, 214, 181, 0.4));
        }

        /* =========================================
           UI å±¤
           ========================================= */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; background: transparent; overflow: hidden; transition: opacity 0.5s;
        }

        /* å·è»¸ç¢ºèªè¦–çª— */
        #scroll-confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 45000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #scroll-confirm-modal.active .confirm-box { transform: scale(1); }
        .confirm-box {
            width: 350px; padding: 40px;
            background: linear-gradient(135deg, #101823 0%, #1a2533 100%);
            border: 2px solid #00f0ff; box-shadow: 0 0 30px rgba(0, 240, 255, 0.3), inset 0 0 20px rgba(0, 240, 255, 0.1);
            border-radius: 15px; text-align: center;
            transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .confirm-title { font-size: 2rem; color: #ffd700; margin-bottom: 20px; text-shadow: 0 0 10px #ffd700; letter-spacing: 2px; }
        .confirm-text { font-size: 1.3rem; color: #fff; margin-bottom: 30px; line-height: 1.6; letter-spacing: 1px; }
        .confirm-btn-group { display: flex; justify-content: space-around; gap: 15px; }
        .confirm-btn { padding: 10px 30px; border: none; border-radius: 50px; font-size: 1.2rem; cursor: pointer; transition: 0.3s; font-family: inherit; }
        .btn-yes { background: linear-gradient(to right, #00f0ff, #0088ff); color: #000; box-shadow: 0 0 15px #00f0ff; font-weight: bold; }
        .btn-yes:hover { transform: scale(1.1); filter: brightness(1.2); }
        .btn-no { background: #333; color: #aaa; border: 1px solid #555; }
        .btn-no:hover { background: #444; color: #fff; }

        /* è‡ªè¨‚è­¦å ±è¦–çª— */
        #custom-alert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 50000;
            display: none; justify-content: center; align-items: center;
        }
        #custom-alert.active .alert-box { animation: alertShake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .alert-box {
            width: 320px; padding: 30px; background: rgba(30, 0, 0, 0.95);
            border: 2px solid #ff0000; border-radius: 10px;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5); text-align: center; position: relative;
        }
        .alert-icon { font-size: 3rem; margin-bottom: 10px; }
        .alert-title { color: #ff3333; font-size: 1.8rem; margin-bottom: 15px; text-shadow: 0 0 10px red; }
        .alert-msg { color: #fff; font-size: 1.2rem; margin-bottom: 25px; line-height: 1.5; }
        .alert-btn {
            padding: 8px 30px; background: #ff0000; color: #fff; border: none; 
            border-radius: 5px; font-size: 1.1rem; cursor: pointer; 
            box-shadow: 0 0 15px #ff0000; font-family: inherit;
        }
        .alert-btn:hover { background: #ff4444; }

        /* â˜…â˜…â˜… é“å…·å¡ç‰‡å±¤ (Item Get) â˜…â˜…â˜… */
        #item-get-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 60; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            perspective: 1500px;
            transition: opacity 0.5s; /* åŸºæœ¬æ·¡å‡º */
        }
        /* ç™½å…‰éå ´é®ç½© (æ–°å¢) */
        #white-transition-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 60000; opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .sunburst {
            position: absolute; width: 200vmax; height: 200vmax;
            background: repeating-conic-gradient(from 0deg, rgba(255, 215, 0, 0.1) 0deg 10deg, transparent 10deg 20deg);
            animation: rotateSun 30s linear infinite; z-index: 0; pointer-events: none;
        }
        
        .congrats-header {
            font-size: 5rem; margin-bottom: 30px; color: transparent;
            background: linear-gradient(to bottom, #FFD700 20%, #FDB931 50%, #fff 80%);
            -webkit-background-clip: text;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8)); text-shadow: 0 10px 20px rgba(0,0,0,0.8);
            letter-spacing: 5px; z-index: 15; opacity: 0; transform: translateY(-50px);
            animation: slideDownText 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.2) 0.3s forwards;
        }
        @keyframes slideDownText { to { opacity: 1; transform: translateY(0); } }

        .legendary-card-container {
            position: relative; width: 340px; height: 500px; z-index: 10;
            animation: cardEntrance 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.2) forwards; opacity: 0;
            cursor: pointer; transition: transform 0.2s;
        }
        .legendary-card-container:active { transform: scale(0.95); } /* é»æ“Šåé¥‹ */

        .legendary-card {
            width: 100%; height: 100%; position: relative; border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.6), 0 0 100px rgba(255, 215, 0, 0.3);
            transform-style: preserve-3d; background: #000;
        }
        .card-frame {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 4px solid #FFD700; z-index: 5;
            box-shadow: inset 0 0 30px #FFD700;
        }
        .card-bg {
            position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px;
            background: linear-gradient(160deg, #1a0f30 0%, #3a1c71 50%, #d76d77 100%);
            z-index: 1; overflow: hidden;
        }
        .card-bg::before {
            content: ''; position: absolute; width: 200%; height: 200%;
            background-image: radial-gradient(rgba(255,255,255,0.3) 1px, transparent 1px);
            background-size: 30px 30px; opacity: 0.3;
        }
        .card-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 50px 20px; box-sizing: border-box; color: #fff;
        }
        
        .card-header-group { text-align: center; width: 100%; }
        .rarity-text {
            font-size: 4.5rem; color: transparent;
            background: linear-gradient(to bottom, #FFD700 0%, #fff 50%, #FFD700 100%);
            -webkit-background-clip: text; 
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
            font-style: italic; font-weight: 900; line-height: 1; margin-bottom: 10px;
        }
        .type-text { 
            display: block; font-size: 1.6rem; color: #FDB931; 
            letter-spacing: 10px; font-weight: bold; text-shadow: 0 2px 5px rgba(0,0,0,0.8); border: none;
        }
        .card-icon { 
            font-size: 9rem; filter: drop-shadow(0 0 30px #FFD700); 
            animation: iconFloat 3s ease-in-out infinite alternate; margin-top: -10px;
        }
        .item-name-card {
            font-size: 3.2rem;
            background: linear-gradient(to bottom, #fff 20%, #FFD700 100%);
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 5px 20px rgba(0,0,0,0.8);
            border: none; width: 100%; text-align: center; letter-spacing: 5px;
        }
        
        .card-shockwave {
            position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            border-radius: 50%; animation: shockwave 0.8s ease-out 0.3s forwards; z-index: 0;
        }
        .tap-continue {
            margin-top: 40px; font-size: 1.5rem; color: #aaa; letter-spacing: 2px;
            animation: fadeIn 1s 2s forwards, pulse 1s infinite; opacity: 0; z-index: 2;
        }

        /* Boss å±¤ */
        #boss-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.2); z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s;
        }
        .warning-sign {
            position: fixed; top: 10%; color: #ff3333; font-size: 2.5rem;
            border: 4px solid #ff3333; padding: 10px 40px; 
            text-shadow: 0 0 20px #ff0000; box-shadow: 0 0 30px #ff0000, inset 0 0 20px #ff0000;
            animation: warnFlash 0.5s infinite alternate; letter-spacing: 5px; z-index: 20002;
        }
        #boss-wrapper {
            position: fixed; display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20005; cursor: crosshair; transition: top 0.6s ease-in-out, left 0.6s ease-in-out;
        }
        #boss-avatar { font-size: 8rem; filter: drop-shadow(0 0 30px #a0f); transition: transform 0.1s; user-select: none; }
        #boss-avatar:active { transform: scale(0.9); }
        .boss-hit { animation: shakeBoss 0.3s; filter: brightness(5) drop-shadow(0 0 50px red) !important; }
        .boss-scary { filter: drop-shadow(0 0 30px #ff0000) contrast(1.5) sepia(1) hue-rotate(-50deg); animation: scaryShake 0.1s infinite; font-size: 12rem !important; }
        #boss-hp-container {
            width: 150px; height: 12px; border: 2px solid #fff; margin-bottom: 10px;
            border-radius: 10px; overflow: hidden; background: #333; box-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        #boss-hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0000, #ff8800); transition: width 0.2s; }
        .damage-text {
            position: absolute; color: #fff; font-weight: bold; font-size: 2rem;
            pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 0 0 5px red;
            z-index: 20020; font-family: 'Arial Black', sans-serif;
        }
        .boss-hint { 
            position: fixed; bottom: 10%; color: #aaa; margin-top: 10px; font-size: 1.2rem; letter-spacing: 2px; animation: pulse 1s infinite; 
        }
        .taunt-text {
            position: absolute; color: #ff00ff; font-size: 1.8rem;
            pointer-events: none; text-shadow: 0 0 10px #000; animation: popUp 0.8s forwards; white-space: nowrap; z-index: 20010;
        }
        #player-weapon {
            position: fixed; font-size: 5rem; opacity: 0; pointer-events: none; z-index: 20010;
            filter: drop-shadow(0 0 10px #fff);
        }
        .weapon-strike { animation: weaponAttack 0.25s ease-out forwards; }

        /* å¯¶ç®± */
        #start-btn-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; flex-direction: column; align-items: center; z-index: 4000;
        }
        #chest-wrapper {
            position: relative; width: 220px; height: 180px; cursor: pointer; z-index: 50; display: none;
            animation: chestDrop 1s cubic-bezier(0.5, -0.5, 0.2, 1.5); filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }
        .chest-base, .chest-lid {
            position: absolute; width: 100%; background: linear-gradient(135deg, #5c2a0d 0%, #8b4513 50%, #5c2a0d 100%);
            border: 4px solid #3e1e09; box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
        }
        .chest-base { bottom: 0; height: 65%; border-radius: 0 0 20px 20px; }
        .chest-base::before {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 20px;
            background: #FFD700; border-radius: 0 0 16px 16px; border-top: 2px solid #DAA520;
        }
        .chest-lid {
            bottom: 63%; height: 45%; border-radius: 20px 20px 0 0; transform-origin: bottom center;
            transition: transform 0.6s cubic-bezier(0.4, 2, 0.5, 1); z-index: 2;
            background: linear-gradient(to bottom, #a0522d, #8b4513);
        }
        .chest-strap {
            position: absolute; width: 24px; height: 100%; top: 0;
            background: linear-gradient(to right, #B8860B, #FFD700, #B8860B);
            border-left: 1px solid #fff; border-right: 1px solid #000; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .chest-strap.left { left: 40px; } .chest-strap.right { right: 40px; }
        .chest-strap::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#8B4513 15%, transparent 16%); background-size: 24px 24px;
        }
        .chest-lock {
            position: absolute; top: 100%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #fff, #FFD700, #DAA520);
            border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 15px #FFD700, 0 5px 10px rgba(0,0,0,0.5);
            z-index: 5; transition: all 0.3s;
        }
        .chest-lock::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 18px; background: #3e1e09; border-radius: 20px 20px 0 0;
        }
        #chest-wrapper.opened .chest-lid { transform: rotateX(120deg) translateY(-30px); }
        #chest-wrapper.opened .chest-lock { opacity: 0; transform: translate(-50%, -100px) scale(2); }
        .chest-godray {
            position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            box-shadow: 0 0 100px 50px #fff; z-index: 10; opacity: 0;
        }
        #chest-wrapper.opened .chest-godray { animation: godRayFlash 1s ease-out forwards; }
        
        /* å·è»¸æŒ‰éˆ•èˆ‡å…§å®¹ */
        #scroll-content { display: none; flex-direction: column; align-items: center; }
        #scroll-icon { 
            font-size: 8rem; margin-bottom: 30px; 
            filter: drop-shadow(0 0 20px #ffd700); 
            animation: floatScroll 3s ease-in-out infinite; 
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* å¢åŠ éå ´æ™‚çš„å½ˆæ€§å‹•ç•« */
        }
        /* ç•¶å·è»¸å•Ÿå‹•æ™‚ï¼Œè®“å®ƒè¡å‘é¡é ­ */
        #scroll-icon.warp-drive {
            animation: warpDriveGo 1.5s ease-in forwards !important;
        }

        #start-btn {
            padding: 15px 40px; font-size: 1.8rem; letter-spacing: 3px; 
            color: #e8d6b5; background: rgba(0, 0, 0, 0.6); border: 2px solid #e8d6b5; border-radius: 10px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 0 15px rgba(232, 214, 181, 0.2); font-family: inherit;
        }
        #start-btn:hover { background: #e8d6b5; color: #000; box-shadow: 0 0 50px #e8d6b5; transform: scale(1.05); }

        /* æ•‘æ´èˆ‡ç«æŸ´äºº */
        #help-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9); border: 2px solid #00f0ff; box-shadow: 0 0 30px #00f0ff;
            padding: 30px; border-radius: 15px; text-align: center; z-index: 30000; display: none;
            flex-direction: column; gap: 20px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #help-modal h2 { margin: 0; color: #fff; font-size: 1.8rem; }
        #help-modal p { margin: 0; color: #aaa; font-size: 1.2rem; }
        .help-btn-group { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .help-btn { padding: 10px 30px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 5px; transition: 0.3s; font-family: inherit; }
        
        /* è¶…ç´šè³½äºäººç«æŸ´äººçµæ§‹ */
        #stickman-hero {
            position: fixed; bottom: 10%; left: -200px; width: 150px; height: 200px;
            z-index: 29000; pointer-events: none; 
            opacity: 0; transition: opacity 0.2s, transform 0.2s;
        }
        .saiyan-aura {
            position: absolute; top: 50%; left: 50%; width: 250px; height: 300px;
            background: radial-gradient(ellipse at center, rgba(255, 215, 0, 0.6) 0%, rgba(255, 215, 0, 0) 70%);
            transform: translate(-50%, -50%); z-index: -2; filter: blur(20px);
            animation: auraPulse 0.15s infinite alternate; opacity: 0; transition: opacity 0.5s;
        }
        #stickman-hero.attacking .saiyan-aura { opacity: 1; }
        #stickman-hero.attacking .stick-head,
        #stickman-hero.attacking .stick-body,
        #stickman-hero.attacking .stick-arm-l,
        #stickman-hero.attacking .stick-arm-r,
        #stickman-hero.attacking .stick-leg-l,
        #stickman-hero.attacking .stick-leg-r {
             background: #FFFACD; border-color: #FFFACD; box-shadow: 0 0 15px #FFD700;
        }
        #stickman-hero.attacking .stick-head { background: transparent; }

        .stick-head { width: 40px; height: 40px; border: 4px solid #fff; border-radius: 50%; position: absolute; top: 0; left: 55px; z-index: 2; }
        .stick-head::after {
            content: ''; position: absolute; top: 12px; left: 8px; width: 20px; height: 8px;
            background: linear-gradient(to right, transparent 40%, #00f0ff 50%, transparent 60%);
            box-shadow: 0 0 5px #00f0ff; opacity: 0; transition: opacity 0.3s;
        }
        #stickman-hero.attacking .stick-head::after { opacity: 1; background: #00f0ff; clip-path: polygon(0 0, 100% 40%, 0 100%); width: 25px; height: 12px; }

        .saiyan-hair-container {
            position: absolute; top: -45px; left: 50%; transform: translateX(-50%);
            width: 80px; height: 60px; z-index: -1;
        }
        .spike {
            position: absolute; bottom: 0; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 50px solid #FFD700; filter: drop-shadow(0 0 5px #FFD700);
        }
        .s1 { left: 0px; transform: rotate(-35deg); height: 40px; }
        .s2 { left: 30px; transform: translateY(-10px) scale(1.4); }
        .s3 { right: 0px; transform: rotate(35deg); height: 40px; }

        .stick-body { width: 4px; height: 80px; background: #fff; position: absolute; top: 40px; left: 73px; }
        .stick-arm-l { width: 4px; height: 50px; background: #fff; position: absolute; top: 50px; left: 73px; transform-origin: top center; transform: rotate(30deg); }
        .stick-arm-r { 
            width: 4px; height: 50px; background: #fff; position: absolute; top: 50px; left: 73px; 
            transform-origin: top center; transform: rotate(-60deg); transition: transform 0.1s;
            display: flex; justify-content: center;
        }
        .stick-sword { 
            width: 8px; height: 0px; background: linear-gradient(to top, #00f0ff 60%, #fff 100%); 
            position: absolute; top: 45px; left: -2px; 
            box-shadow: 0 0 25px #00f0ff, inset 0 0 5px #fff; 
            transform-origin: center top; transform: rotate(-10deg); z-index: -1; 
            transition: height 0.2s ease-out;
        }
        .stick-sword.ignite { height: 140px; }

        .stick-leg-l { width: 4px; height: 60px; background: #fff; position: absolute; top: 115px; left: 73px; transform-origin: top center; transform: rotate(20deg); }
        .stick-leg-r { width: 4px; height: 60px; background: #fff; position: absolute; top: 115px; left: 73px; transform-origin: top center; transform: rotate(-20deg); }
        
        .slash-fx {
            position: fixed; top: 50%; left: 50%; width: 150%; height: 8px; background: #fff;
            transform: translate(-50%, -50%) rotate(-15deg) scaleX(0); box-shadow: 0 0 50px 20px #00f0ff;
            z-index: 29500; opacity: 0; pointer-events: none;
        }
        #stickman-hero.attacking .stick-arm-r { transform: rotate(-160deg); }
        #stickman-hero.slashing .stick-arm-r { transform: rotate(45deg); transition: transform 0.05s ease-out; }

        /* å‹•ç•«å®šç¾© */
        @keyframes nebula-move { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.1); opacity: 1; } }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes floatScroll { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes textPulse { from { opacity: 0.6; } to { opacity: 1; text-shadow: 0 0 40px #ffd700; } }
        @keyframes flashOut { 0% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes warnFlash { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0.5; transform: scale(0.98); } }
        @keyframes shakeBoss { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(-10px, 10px) rotate(-5deg); } 50% { transform: translate(10px, -10px) rotate(5deg); } 75% { transform: translate(-10px, -10px) rotate(-5deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        @keyframes popUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 50% { transform: translateY(-40px) scale(1.2); opacity: 1; } 100% { transform: translateY(-80px) scale(1); opacity: 0; } }
        @keyframes scaryShake { 0% { transform: translate(2px, 2px) rotate(0deg); } 25% { transform: translate(-2px, -2px) rotate(-2deg); } 50% { transform: translate(-2px, 2px) rotate(2deg); } 75% { transform: translate(2px, -2px) rotate(-2deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes superSlash { 0% { transform: translate(-50%, -50%) rotate(-15deg) scaleX(0); opacity: 1; } 30% { transform: translate(-50%, -50%) rotate(-15deg) scaleX(1); opacity: 1; } 100% { transform: translate(-50%, -50%) rotate(-15deg) scaleX(1); opacity: 0; } }
        @keyframes cardEntrance { 0% { opacity: 0; transform: scale(0.2) rotateY(180deg) translateY(100px); } 60% { opacity: 1; transform: scale(1.1) rotateY(-10deg); } 100% { opacity: 1; transform: scale(1) rotateY(0deg); } }
        @keyframes shockwave { to { width: 800px; height: 800px; box-shadow: 0 0 100px 50px rgba(255, 215, 0, 0); } }
        @keyframes iconFloat { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        @keyframes rotateSun { to { transform: rotate(360deg); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes godRayFlash { 0% { opacity: 1; box-shadow: 0 0 50px 20px #fff; } 100% { opacity: 0; box-shadow: 0 0 500px 200px #FFD700; } }
        @keyframes auraPulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; } 100% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } }
        @keyframes weaponAttack { 0% { opacity: 1; transform: rotate(0deg) scale(1) translate(0, 0); } 50% { opacity: 1; transform: rotate(-60deg) scale(1.2) translate(-20px, 20px); } 100% { opacity: 0; transform: rotate(-90deg) scale(1) translate(-30px, 30px); } }
        @keyframes alertShake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* æ–°å¢ï¼šWarp Drive è¡å‘è¢å¹•çš„å‹•ç•« */
        @keyframes warpDriveGo {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            40% { transform: scale(0.8) translateY(20px); opacity: 1; } /* è“„åŠ› */
            100% { transform: scale(30) translateY(-100px); opacity: 0; } /* è¡åˆº */
        }

        .ember-particle {
            position: absolute; width: 3px; height: 3px; background: #ff4500; border-radius: 50%; pointer-events: none; z-index: 4999;
            box-shadow: 0 0 5px #ff0000; animation: ember-fly 2s linear forwards;
        }

        #status-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: bold; color: #fff; text-shadow: 0 0 20px #ffd700;
            letter-spacing: 5px; display: none; z-index: 20; white-space: nowrap;
        }
        .status-pulse { animation: textPulse 1.5s infinite alternate; }
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10000; opacity: 0; pointer-events: none; }
        .flash-bang { animation: flashOut 2.5s ease-out forwards; }
        #start-btn-container { display: none; } 
    </style>
</head>
<body>

    <audio id="bgm-boss" loop><source src="boss.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-win" loop><source src="win.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-countdown" loop><source src="countdown.mp3" type="audio/mpeg"></audio>
    <audio id="se-click"><source src="click.mp3" type="audio/mpeg"></audio>
    <audio id="se-slash"><source src="slash.mp3" type="audio/mpeg"></audio>
    <audio id="se-warp"><source src="warp.mp3" type="audio/mpeg"></audio>

    <div id="white-transition-overlay"></div>

    <div id="intro-layer">
        
        <div id="custom-alert">
            <div class="alert-box">
                <div class="alert-icon">âš ï¸</div>
                <div class="alert-title">ç³»çµ±è­¦å‘Š</div>
                <div class="alert-msg"></div>
                <button class="alert-btn" onclick="closeCustomAlert()">ç¢º å®š</button>
            </div>
        </div>

        <div id="scroll-confirm-modal">
            <div class="confirm-box">
                <div class="confirm-title">ğŸ“œ ç³»çµ±æç¤º</div>
                <div class="confirm-text">æª¢æ¸¬åˆ°é«˜æ¿ƒåº¦å›æ†¶èƒ½é‡ã€‚<br>æ˜¯å¦ç«‹å³å•Ÿç”¨ã€Œå›æ†¶å·è»¸ã€ï¼Ÿ</div>
                <div class="confirm-btn-group">
                    <button class="confirm-btn btn-yes" onclick="confirmStart(true)">æ˜¯ (Yes)</button>
                    <button id="btn-no" class="confirm-btn btn-no" onclick="confirmStart(false)">å¦ (No)</button>
                </div>
            </div>
        </div>
        
        <canvas id="particle-canvas"></canvas>

        <div id="item-get-layer" onclick="finishItemGet()">
            <div class="sunburst"></div>
            <div class="congrats-header">æ­å–œç²å¾—</div>
            
            <div class="legendary-card-container">
                <div class="card-shockwave"></div>
                <div class="legendary-card">
                    <div class="card-frame"></div>
                    <div class="card-bg"></div>
                    <div class="card-content">
                        <div class="card-header-group">
                            <span class="rarity-text">S-RANK</span>
                            <span class="type-text">å‚³èªªé“å…·</span>
                        </div>
                        <div class="card-icon">ğŸ“œ</div>
                        <div class="card-footer"><div class="item-name-card">å›æ†¶å·è»¸</div></div>
                    </div>
                </div>
            </div>
            <div class="tap-continue">- é»æ“Šä»»æ„è™•é ˜å– -</div>
        </div>

        <div id="boss-layer">
            <div class="warning-sign">âš ï¸ è­¦å‘ŠBOSSå‡ºæ²’ âš ï¸</div>
            
            <div id="boss-wrapper" onclick="hitBoss(event)">
                <div id="boss-hp-container"><div id="boss-hp-bar"></div></div>
                <div id="boss-avatar">ğŸ‘¾</div>
            </div>
            
            <div id="player-weapon">ğŸª“</div>

            <div class="boss-hint">>> é»æ“Šæ€ªç‰©é€²è¡Œæ”»æ“Š <<</div>
        </div>

        <div id="start-btn-container">
            <div id="scroll-content">
                <div id="scroll-icon">ğŸ“œ</div>
                <button id="start-btn" onclick="askToStart()">æ‹¾å–å›æ†¶å·è»¸</button>
            </div>
            <div id="chest-wrapper" onclick="openChest()">
                <div class="chest-lid">
                    <div class="chest-strap left"></div><div class="chest-strap right"></div><div class="chest-lock"></div>
                </div>
                <div class="chest-base">
                    <div class="chest-strap left"></div><div class="chest-strap right"></div>
                </div>
                <div class="chest-godray"></div>
            </div>
        </div>

        <div id="help-modal">
            <h2>âš ï¸ è‹¦æˆ°è­¦å‘Š âš ï¸</h2>
            <p id="help-text-1">Boss å¤ªå¼·äº†å—ï¼Ÿæ²’é—œä¿‚çš„</p>
            <p id="help-text-2">æ˜¯å¦éœ€è¦ <b>å¸¥å“¥é˜¿è«¾</b> é€²è¡Œæ”¯æ´ï¼Ÿ</p>
            <div class="help-btn-group">
                <button class="help-btn btn-yes" onclick="summonAuthor()">æ˜¯ï¼Œæ•‘æ•‘æˆ‘ï¼</button>
                <button class="help-btn btn-no" onclick="rejectHelp()">å¦ï¼Œæˆ‘è‡ªå·±ä¾†</button>
            </div>
        </div>

        <div id="stickman-hero">
            <div class="saiyan-aura"></div>
            <div class="stick-head">
                <div class="saiyan-hair-container">
                    <div class="spike s1"></div>
                    <div class="spike s2"></div>
                    <div class="spike s3"></div>
                </div>
            </div>
            <div class="stick-body"></div>
            <div class="stick-arm-l"></div>
            <div class="stick-arm-r">
                <div class="stick-sword"></div>
            </div>
            <div class="stick-leg-l"></div>
            <div class="stick-leg-r"></div>
        </div>
        <div id="slash-layer" class="slash-fx"></div>

        <div id="status-message"></div>
    </div>
    
    <div id="flash-overlay"></div>
    
    <div id="battle-bg"></div>
    
    <div id="bg-layer"><div class="nebula-cloud"></div></div>

<script>
    // ä¸»è¦è®Šæ•¸
    let pCtx, pCanvas, pW, pH;
    let digitParticles = [];   
    let animationId;
    let pCount = 5; 
    let cachedDigitPoints = {}; 
    const premiumGoldColors = ['#FFD700', '#FDB931', '#FFFACD', '#BF953F', '#FFFFFF'];

    function switchMusic(playId) {
        const audios = ['bgm-boss', 'bgm-win', 'bgm-countdown'];
        audios.forEach(id => {
            const audio = document.getElementById(id);
            if(audio) { audio.pause(); audio.currentTime = 0; }
        });
        if(playId) {
            const target = document.getElementById(playId);
            if(target) { target.volume = 0.5; target.play().catch(e => console.log("éŸ³æ•ˆç­‰å¾…äº’å‹•:", e)); }
        }
    }

    function initButtonSound() {
        const clickSound = document.getElementById('se-click');
        if (!clickSound) return;
        clickSound.volume = 0.6;
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                clickSound.currentTime = 0; clickSound.play().catch(() => {});
            });
        });
        ['#chest-wrapper', '#boss-wrapper', '#item-get-layer'].forEach(selector => {
            const el = document.querySelector(selector);
            if(el) el.addEventListener('click', () => {
                clickSound.currentTime = 0; clickSound.play().catch(() => {});
            });
        });
    }
    initButtonSound();

    // å€’æ•¸èˆ‡ Canvas ç›¸é—œ (é‚è¼¯ä¿æŒä¸è®Šï¼Œè½‰å ´å„ªåŒ–åœ¨ä¸‹é¢)
    function startCountdown() {
        switchMusic('bgm-countdown');
        document.getElementById('start-btn-container').style.display = 'none';
        const statusMsg = document.getElementById('status-message');
        const intro = document.getElementById('intro-layer');
        const flash = document.getElementById('flash-overlay');

        initCanvas(); 
        statusMsg.innerText = "å›æ†¶å·è»¸å•Ÿå‹•ä¸­...";
        statusMsg.style.display = "block"; statusMsg.classList.add('status-pulse');
        preCalculateDigits(); animate(); 

        setTimeout(() => {
            statusMsg.style.display = "none"; statusMsg.classList.remove('status-pulse');
            runCountdownSequence();
        }, 1500);

        async function runCountdownSequence() {
            while (pCount > 0) {
                useCachedParticles(pCount); await wait(1200);
                explodeParticles(); await wait(600); 
                pCount--;
            }
            statusMsg.innerText = "å›æ†¶å·è»¸å•Ÿå‹•å®Œæˆ";
            statusMsg.style.display = "block"; statusMsg.classList.add('status-pulse');
            await wait(1000); cancelAnimationFrame(animationId);
            flash.classList.add('flash-bang'); intro.style.opacity = 0;
            switchMusic(null); await wait(500);
            window.location.href = 'memory.html';
        }
    }
    
    // Canvas & Particles Logic (ä¿æŒä¸è®Š)
    function preCalculateDigits() { for(let i = 1; i <= 5; i++) { cachedDigitPoints[i] = performScan(i); } }
    function performScan(text) {
        const points = []; const scale = 0.25; const sW = Math.floor(pW * scale); const sH = Math.floor(pH * scale);
        const tmpCanvas = document.createElement('canvas'); const tmpCtx = tmpCanvas.getContext('2d');
        tmpCanvas.width = sW; tmpCanvas.height = sH;
        const fontSize = Math.min(pW, pH) * 0.35 * scale; tmpCtx.font = `900 ${fontSize}px Arial Black`;
        tmpCtx.fillStyle = '#fff'; tmpCtx.textAlign = 'center'; tmpCtx.textBaseline = 'middle';
        tmpCtx.fillText(text, sW/2, sH/2);
        const imgData = tmpCtx.getImageData(0, 0, sW, sH).data; const gap = 2; 
        for(let y = 0; y < sH; y += gap) {
            for(let x = 0; x < sW; x += gap) {
                if(imgData[(y * sW + x) * 4 + 3] > 128) points.push({ x: x / scale, y: y / scale });
            }
        }
        return points;
    }
    function useCachedParticles(num) {
        const points = cachedDigitPoints[num] || []; digitParticles = []; 
        points.forEach(p => {
            const angle = Math.random() * Math.PI * 2; const dist = Math.max(pW, pH) * 0.8; 
            digitParticles.push({
                x: pW/2 + Math.cos(angle) * dist, y: pH/2 + Math.sin(angle) * dist, tx: p.x, ty: p.y,
                vx: 0, vy: 0, size: Math.random() * 3.5 + 1.5, color: premiumGoldColors[Math.floor(Math.random() * premiumGoldColors.length)],
                alpha: 1, isExploding: false, ease: Math.random() * 0.06 + 0.04 
            });
        });
    }
    function explodeParticles() {
        digitParticles.forEach(p => {
            p.isExploding = true; const angle = Math.random() * Math.PI * 2; const force = (Math.random() * 50 + 50) * (Math.min(pW, pH) / 1000); 
            p.vx = Math.cos(angle) * force; p.vy = Math.sin(angle) * force;
        });
    }
    function initCanvas() {
        pCanvas = document.getElementById('particle-canvas'); pCtx = pCanvas.getContext('2d');
        resize(); window.addEventListener('resize', resize);
    }
    function resize() { pW = pCanvas.width = window.innerWidth; pH = pCanvas.height = window.innerHeight; }
    function animate() {
        pCtx.fillStyle = '#000'; pCtx.fillRect(0, 0, pW, pH); 
        for (let i = 0; i < digitParticles.length; i++) {
            let p = digitParticles[i];
            if (p.isExploding) { p.x += p.vx; p.y += p.vy; p.vx *= 0.96; p.vy *= 0.96; p.alpha -= 0.015; p.size *= 0.97; } 
            else { p.x += (p.tx - p.x) * p.ease; p.y += (p.ty - p.y) * p.ease; }
            if (p.alpha > 0.05) {
                pCtx.beginPath(); pCtx.arc(p.x, p.y, p.size, 0, Math.PI*2); pCtx.fillStyle = p.color; pCtx.globalAlpha = p.alpha; pCtx.fill(); pCtx.globalAlpha = 1; 
            }
        }
        animationId = requestAnimationFrame(animate);
    }

    // Boss æˆ°é¬¥é‚è¼¯
    let bossPhase = 1, bossHP = 100, maxHP = 100, p2MaxHP = 300, clickTimer = null, isTeleporting = false, moveInterval = null, helpTimer = null, tauntInterval = null;
    const bossLayer = document.getElementById('boss-layer');
    const bossAvatar = document.getElementById('boss-avatar');
    const bossWrapper = document.getElementById('boss-wrapper');
    const playerWeapon = document.getElementById('player-weapon');
    const hpBar = document.getElementById('boss-hp-bar');
    const warningSign = document.querySelector('.warning-sign');
    const bossHint = document.querySelector('.boss-hint');
    const startBtnContainer = document.getElementById('start-btn-container');
    const helpModal = document.getElementById('help-modal');

    function initBossBattle() {
        bossPhase = 1; bossHP = 100; maxHP = 100;
        bossHint.innerText = ">> é»æ“Šæ€ªç‰©é€²è¡Œæ”»æ“Š <<"; bossAvatar.innerText = "ğŸ‘»"; bossAvatar.style.fontSize = "8rem";
        bossAvatar.classList.remove('boss-scary'); bossAvatar.style.opacity = 1;
        updateHPBar();
        if(moveInterval) clearInterval(moveInterval); if(tauntInterval) clearInterval(tauntInterval); if(helpTimer) clearTimeout(helpTimer);
        helpModal.style.display = 'none';
        switchMusic('bgm-boss');
    }
    initBossBattle();

    function hitBoss(e) {
        if(bossHP <= 0 && bossPhase === 2) return; if(isTeleporting) return;
        const x = e.clientX; const y = e.clientY;
        triggerWeaponAnimation(x, y);
        if (bossPhase === 1) handlePhase1Damage(x, y);
        else handlePhase2Logic(x, y);
    }

    function triggerWeaponAnimation(x, y) {
        playerWeapon.style.left = (x + 20) + 'px'; playerWeapon.style.top = (y - 50) + 'px'; playerWeapon.style.opacity = 1;
        playerWeapon.classList.remove('weapon-strike'); void playerWeapon.offsetWidth; playerWeapon.classList.add('weapon-strike');
    }

    function handlePhase2Logic(x, y) {
        if (clickTimer) {
            clearTimeout(clickTimer); clickTimer = null;
            const damage = Math.floor(Math.random() * 30) + 20; applyDamage(damage, x, y);
            bossHint.innerText = ">> æˆåŠŸé€£æ“Šï¼é€ æˆå‚·å®³ï¼ <<"; bossHint.style.color = "#ff3333";
            if(bossHP <= 0) bossDie();
        } else {
            bossAvatar.style.transform = "scale(2.1)"; setTimeout(() => bossAvatar.style.transform = "scale(2.0)", 100);
            clickTimer = setTimeout(() => { clickTimer = null; teleportBoss(); }, 280);
        }
    }

    function handlePhase1Damage(x, y) {
        if(bossHP === maxHP) {
            warningSign.innerText = "æ±‚é¥’ä¸­..."; warningSign.style.color = "#ffff00"; warningSign.style.borderColor = "#ffff00"; bossHint.innerText = "Boss: å“å”·ï¼åˆ¥æ‰“è‡‰ï¼";
        } else {
            const begs = ["é¥’å‘½å•Šï¼", "æˆ‘éŒ¯äº†ï¼", "åˆ¥æ‰“äº†ï¼", "ç—›ç—›ç—›ï¼"];
            showTauntText(x, y, begs[Math.floor(Math.random() * begs.length)], '#fff');
        }
        const damage = Math.floor(Math.random() * 15) + 10; applyDamage(damage, x, y);
        if(bossHP <= 0) { bossHP = 0; transformToPhase2(); }
    }

    function transformToPhase2() {
        bossPhase = 2; bossHP = p2MaxHP; 
        warningSign.innerText = " BOSS æš´èµ°ä¸­"; warningSign.style.color = "#ff0000"; warningSign.style.borderColor = "#ff0000"; warningSign.style.animation = "warnFlash 0.1s infinite alternate"; 
        bossAvatar.innerText = "ğŸ˜ˆ"; bossAvatar.classList.add('boss-scary'); 
        bossHint.innerText = "âš ï¸ é–å®šç›®æ¨™ï¼šè«‹å¿«é€Ÿé€£é»å…©ä¸‹ï¼"; bossHint.style.color = "#00f0ff";
        showTauntText(window.innerWidth/2, window.innerHeight/2, "å¼å–”å–”å–”å–”ï¼ï¼ï¼", "#ff0000");
        updateHPBar(); startAutoMove();

        tauntInterval = setInterval(() => {
            if(isTeleporting) return;
            const rect = bossWrapper.getBoundingClientRect();
            const activeTaunts = ["æ‰“ä¸åˆ°ï½", "å¤ªæ…¢äº†ï¼", "å°±é€™ï¼Ÿ", "å¥½ç™¢å–”", "æ”¾æ£„å§ï¼"];
            showTauntText(rect.left + 50, rect.top, activeTaunts[Math.floor(Math.random() * activeTaunts.length)], '#00f0ff');
        }, 2000);

        helpTimer = setTimeout(() => { if(bossHP > 0) { document.getElementById('help-text-1').innerText = "Boss å¤ªå¼·äº†å—ï¼Ÿæ²’é—œä¿‚"; document.getElementById('help-text-2').innerText = "æ˜¯å¦éœ€è¦ å¸¥å“¥é˜¿è«¾ é€²è¡Œæ”¯æ´ï¼Ÿ"; helpModal.style.display = 'flex'; } }, 15000);
    }

    function applyDamage(dmg, x, y) {
        bossHP -= dmg; if(bossHP < 0) bossHP = 0;
        updateHPBar(); bossAvatar.classList.remove('boss-hit'); void bossAvatar.offsetWidth; bossAvatar.classList.add('boss-hit');
        if(x && y) showDamageNumber(x, y, dmg);
    }
    function updateHPBar() { const currentMax = (bossPhase === 1) ? maxHP : p2MaxHP; hpBar.style.width = (bossHP / currentMax) * 100 + '%'; }
    
    function startAutoMove() {
        const rect = bossWrapper.getBoundingClientRect();
        bossWrapper.style.left = rect.left + 'px'; bossWrapper.style.top = rect.top + 'px';
        moveInterval = setInterval(() => { if(!isTeleporting) moveBossRandomly(); }, 800);
    }
    
    function moveBossRandomly() {
        const padding = 150; 
        bossWrapper.style.left = (Math.random() * (window.innerWidth - padding * 2) + padding) + 'px'; 
        bossWrapper.style.top = (Math.random() * (window.innerHeight - padding * 2) + padding) + 'px';
    }
    
    function teleportBoss() {
        isTeleporting = true;
        const taunts = ["æŠ“ä¸åˆ°ï¼", "å¤ªæ…¢äº†ï¼", "ç¬ç§»ï¼", "å¼±çˆ†äº†"]; const rect = bossWrapper.getBoundingClientRect();
        showTauntText(rect.left, rect.top, taunts[Math.floor(Math.random() * taunts.length)], '#00f0ff');
        bossAvatar.style.opacity = 0; 
        setTimeout(() => { moveBossRandomly(); bossAvatar.style.opacity = 1; isTeleporting = false; }, 200);
    }
    function bossDie() {
        switchMusic('bgm-win');
        if(moveInterval) clearInterval(moveInterval); if(tauntInterval) clearInterval(tauntInterval); if(helpTimer) clearTimeout(helpTimer);
        bossAvatar.style.transition = "all 0.5s"; bossAvatar.style.transform = "scale(0) rotate(180deg)"; bossAvatar.style.opacity = 0;
        warningSign.innerText = "VICTORY!"; warningSign.style.borderColor = "#ffd700"; warningSign.style.color = "#ffd700"; bossHint.style.display = 'none';
        setTimeout(() => {
            bossLayer.style.opacity = 0;
            setTimeout(() => { bossLayer.style.display = 'none'; startBtnContainer.style.display = 'flex'; document.getElementById('chest-wrapper').style.display = 'block'; document.getElementById('scroll-content').style.display = 'none'; }, 1000);
        }, 800);
    }
    function showDamageNumber(x, y, dmg) {
        const el = document.createElement('div'); el.className = 'damage-text'; el.innerText = '-' + dmg;
        el.style.left = (x + (Math.random() - 0.5) * 40) + 'px'; el.style.top = (y - 30) + 'px';
        bossLayer.appendChild(el); setTimeout(() => el.remove(), 800);
    }
    function showTauntText(x, y, text, color) {
        const el = document.createElement('div'); el.className = 'taunt-text'; el.innerText = text; el.style.color = color;
        el.style.left = x + 'px'; el.style.top = (y - 80) + 'px'; bossLayer.appendChild(el); setTimeout(() => el.remove(), 800);
    }

    function rejectHelp() {
        helpModal.style.display = 'none'; if(helpTimer) clearTimeout(helpTimer);
        helpTimer = setTimeout(() => { if(bossHP > 0 && bossPhase === 2) { document.getElementById('help-text-1').innerText = "çœŸçš„ä¸éœ€è¦å¹«å¿™å—ï¼Ÿ"; document.getElementById('help-text-2').innerText = "å¸¥å“¥é˜¿è«¾éš¨æ™‚æº–å‚™å‡ºæ‰‹å–”ï¼"; helpModal.style.display = 'flex'; } }, 5000);
    }
    
    // æ•‘å ´å‹•ç•«é‚è¼¯ (ç¬ç§»æ–¬)
    async function summonAuthor() {
        helpModal.style.display = 'none'; 
        if(moveInterval) clearInterval(moveInterval); 
        if(tauntInterval) clearInterval(tauntInterval);
        
        const hero = document.getElementById('stickman-hero'); 
        const sword = hero.querySelector('.stick-sword');
        const slash = document.getElementById('slash-layer'); 
        const bossRect = bossWrapper.getBoundingClientRect();
        
        hero.style.left = (bossRect.left - 150) + 'px'; 
        hero.style.top = (bossRect.top + 50) + 'px'; 
        hero.style.transform = "scale(1) skewX(-20deg)"; 
        hero.style.opacity = 1; 
        
        await wait(300); 
        hero.style.transform = "scale(1)";
        sword.classList.add('ignite'); 
        
        await wait(500); 
        hero.classList.add('attacking'); 
        showTauntText(bossRect.left - 150, bossRect.top - 100, "å¸¥å“¥é˜¿è«¾ï¼šå€Ÿéï¼", "#00f0ff");
        
        await wait(800); 
        const slashSound = document.getElementById('se-slash'); 
        if(slashSound) { slashSound.currentTime = 0; slashSound.play().catch(console.error); }
        
        hero.style.transition = "left 0.1s";
        hero.style.left = (bossRect.left + 300) + 'px'; 
        hero.classList.add('slashing');
        
        slash.style.left = (bossRect.left + 100) + 'px'; 
        slash.style.top = (bossRect.top + 100) + 'px'; 
        slash.style.animation = "superSlash 0.3s forwards";
        
        await wait(200); 
        applyDamage(99999, bossRect.left, bossRect.top); 
        bossDie();
        
        await wait(2000); 
        hero.style.opacity = 0; 
        setTimeout(() => { 
            hero.style.left = "-200px"; 
            hero.classList.remove('attacking', 'slashing'); 
            sword.classList.remove('ignite');
        }, 500); 
    }

    // å¯¶ç®±èˆ‡å·è»¸ç³»çµ±
    function openChest() {
        const chest = document.getElementById('chest-wrapper'); const itemLayer = document.getElementById('item-get-layer');
        if(chest.classList.contains('opened')) return;
        chest.classList.add('opened'); chest.style.animation = "shake 0.5s";
        setTimeout(() => {
            if (itemLayer) itemLayer.style.display = 'flex'; else finishItemGet();
            
            const bg = document.getElementById('battle-bg');
            if(bg) bg.style.opacity = 0;

            chest.style.transition = "opacity 0.5s"; chest.style.opacity = 0;
            setTimeout(() => { chest.style.display = 'none'; }, 500);
        }, 800);
    }

    // â˜…â˜…â˜… è½‰å ´ 1 å„ªåŒ–ï¼šé“å…·ç²å¾— -> æ‹¾å–é é¢ (Flash Morph) â˜…â˜…â˜…
    function finishItemGet() {
        const itemLayer = document.getElementById('item-get-layer'); 
        const scrollContent = document.getElementById('scroll-content');
        const whiteOverlay = document.getElementById('white-transition-overlay');

        if(whiteOverlay) {
            // 1. ç™½å…‰é–ƒçˆé–‹å§‹ (0.5s)
            whiteOverlay.style.opacity = 1;
            
            setTimeout(() => {
                // 2. åœ¨å…¨ç™½çš„æ™‚å€™åˆ‡æ›å…§å®¹
                if(itemLayer) itemLayer.style.display = 'none';
                if(scrollContent) { 
                    scrollContent.style.display = 'flex'; 
                    // ä¸å†ä½¿ç”¨ floatUpï¼Œæ”¹ç‚ºéœæ­¢æˆ–å¾®å‹•ï¼Œå› ç‚ºæ˜¯è®Šå‡ºä¾†çš„
                    scrollContent.style.animation = "floatScroll 3s ease-in-out infinite"; 
                }
                
                // 3. ç™½å…‰æ·¡å‡º (0.8s)
                whiteOverlay.style.opacity = 0;
            }, 500);
        } else {
            // Fallback if overlay missing
            if(itemLayer) { itemLayer.style.display = 'none'; }
            if(scrollContent) { scrollContent.style.display = 'flex'; }
        }
    }
    
    let rejectCount = 0;
    function askToStart() {
        const modal = document.getElementById('scroll-confirm-modal');
        modal.style.display = 'flex'; setTimeout(() => { modal.style.opacity = 1; modal.classList.add('active'); }, 10);
        const clickSound = document.getElementById('se-click'); if(clickSound) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
    }

    // â˜…â˜…â˜… è½‰å ´ 2 å„ªåŒ–ï¼šä½¿ç”¨å·è»¸ -> æ™‚å…‰éš§é“ (Warp Drive) â˜…â˜…â˜…
    function confirmStart(isYes) {
        const modal = document.getElementById('scroll-confirm-modal');
        const clickSound = document.getElementById('se-click'); if(clickSound) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
        
        if (isYes) {
            modal.style.display = 'none'; modal.classList.remove('active');
            
            const scrollIcon = document.getElementById('scroll-icon'); 
            const startBtn = document.getElementById('start-btn'); 
            const scrollContent = document.getElementById('scroll-content');
            
            // éš±è—æŒ‰éˆ•
            if(startBtn) { 
                startBtn.style.transition = 'opacity 0.3s';
                startBtn.style.opacity = 0; 
                startBtn.style.pointerEvents = 'none'; 
            }

            // 1. å·è»¸è¡å‘é¡é ­å‹•ç•«
            if (scrollIcon) { 
                // æ·»åŠ è¡åˆºå‹•ç•« class
                scrollIcon.classList.add('warp-drive'); 
            }
            
            // 2. èƒŒæ™¯ç¸®æ”¾ç‰¹æ•ˆ (Warp Effect)
            const bgLayer = document.getElementById('bg-layer');
            if(bgLayer) {
                bgLayer.style.transform = "scale(5)";
                bgLayer.style.opacity = 0;
            }

            // 3. ç¸®çŸ­ç­‰å¾…æ™‚é–“ï¼Œä¸¦å•Ÿå‹•æ™‚å…‰éš§é“
            setTimeout(() => { 
                if(scrollContent) scrollContent.style.display = 'none'; 
                startVortexTransition(); 
            }, 1200); // æ”¹ç‚º 1.2ç§’ï¼Œé…åˆ warpDriveGo å‹•ç•«
            
        } else {
            rejectCount++; 
            const noBtn = document.getElementById('btn-no');
            
            if (rejectCount === 1) { 
                showCustomAlert("âš ï¸ ç³»çµ±è­¦å‘Š", "æª¢æ¸¬åˆ°é«˜æ¿ƒåº¦å›æ†¶èƒ½é‡ï¼Œç„¡æ³•å–æ¶ˆï¼");
                noBtn.innerText = "å¦ï¼Ÿ"; noBtn.style.color = "#fff"; 
            } 
            else if (rejectCount === 2) { 
                showCustomAlert("ğŸš« åš´é‡éŒ¯èª¤", "æ‹’çµ•ç„¡æ•ˆã€‚<br>ç©ºé–“å·²ç¶“é–‹å§‹è½‰å‹•...");
                noBtn.innerText = "æ˜¯(Yes)"; noBtn.style.background = "#00f0ff"; noBtn.style.color = "#000"; noBtn.style.boxShadow = "0 0 10px #00f0ff"; 
                noBtn.onclick = function() { confirmStart(true); }; 
            }
        }
    }

    function showCustomAlert(title, msg) {
        const alertModal = document.getElementById('custom-alert');
        const alertBox = alertModal.querySelector('.alert-box');
        alertModal.querySelector('.alert-title').innerText = title;
        alertModal.querySelector('.alert-msg').innerHTML = msg;
        alertModal.style.display = 'flex';
        alertModal.classList.remove('active');
        void alertModal.offsetWidth; 
        alertModal.classList.add('active');
    }

    function closeCustomAlert() {
        const alertModal = document.getElementById('custom-alert');
        alertModal.style.display = 'none';
        alertModal.classList.remove('active');
        const clickSound = document.getElementById('se-click'); if(clickSound) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
    }

    function spawnFireParticles() {
        const scrollIcon = document.getElementById('scroll-icon'); if(!scrollIcon) return;
        const rect = scrollIcon.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
        for(let i=0; i<50; i++) {
            setTimeout(() => {
                const ember = document.createElement('div'); ember.className = 'ember-particle'; document.body.appendChild(ember);
                ember.style.left = centerX + 'px'; ember.style.top = centerY + 'px'; 
                const angle = Math.random() * Math.PI * 2; const dist = 50 + Math.random() * 100;
                ember.style.setProperty('--tx', (Math.cos(angle) * dist) + 'px'); ember.style.setProperty('--ty', (Math.sin(angle) * dist - 50) + 'px');
                const rand = Math.random(); ember.style.backgroundColor = rand > 0.6 ? '#ff4500' : rand > 0.3 ? '#ff8800' : '#555';
                setTimeout(() => ember.remove(), 2000);
            }, i * 40);
        }
    }

    // æ™‚å…‰éš§é“éå ´
    let vortexId, tunnelRings = [], speedLines = [], memoryFragments = [], vortexStartTime = 0;
    const VORTEX_DURATION = 8000;

    function startVortexTransition() {
        const warpSound = document.getElementById('se-warp'); if (warpSound) { warpSound.currentTime = 0; warpSound.volume = 0.8; warpSound.play().catch(console.error); }
        switchMusic('bgm-countdown'); 
        const statusMsg = document.getElementById('status-message'); statusMsg.innerText = "æ­£åœ¨ç©¿è¶Šæ™‚ç©ºè£‚ç¸«..."; statusMsg.style.display = "block"; statusMsg.classList.add('status-pulse');
        initCanvas(); 
        tunnelRings = []; speedLines = []; memoryFragments = []; vortexStartTime = Date.now();
        for(let i=0; i<15; i++) tunnelRings.push({ z: i * 200, rotation: i * 0.1, color: i % 2 === 0 ? '#00f0ff' : '#ffffff' });
        for(let i=0; i<30; i++) speedLines.push({ angle: Math.random() * Math.PI * 2, length: Math.random() * 200 + 100, speed: Math.random() * 10 + 20, dist: Math.random() * 500 + 200 });
        animateVortex();
        setTimeout(() => { finishVortexAndStart(); }, VORTEX_DURATION);
    }

    function animateVortex() {
        const now = Date.now(); const elapsed = now - vortexStartTime; const progress = Math.min(elapsed / VORTEX_DURATION, 1);
        pCtx.fillStyle = `rgba(5, 5, 10, 0.3)`; pCtx.fillRect(0, 0, pW, pH);
        const cx = pW / 2; const cy = pH / 2; const fov = 600;

        pCtx.lineWidth = 3;
        tunnelRings.forEach(ring => {
            ring.z -= 15 + (progress * 30); ring.rotation += 0.02;
            if(ring.z < -fov) { ring.z += 3000; ring.color = Math.random() > 0.5 ? '#00f0ff' : '#ffd700'; }
            const scale = fov / (fov + ring.z); const size = 600 * scale;
            if (size > 0) {
                pCtx.strokeStyle = ring.color; pCtx.globalAlpha = Math.min(1, scale * 2); pCtx.beginPath();
                for (let i = 0; i <= 8; i++) { const theta = (i / 8) * Math.PI * 2 + ring.rotation; i === 0 ? pCtx.moveTo(cx + Math.cos(theta) * size, cy + Math.sin(theta) * size) : pCtx.lineTo(cx + Math.cos(theta) * size, cy + Math.sin(theta) * size); }
                pCtx.closePath(); pCtx.stroke();
            }
        });
        pCtx.globalAlpha = 1;

        pCtx.strokeStyle = '#ffffff'; pCtx.lineWidth = 2; pCtx.beginPath();
        speedLines.forEach(line => {
            line.dist -= line.speed + (progress * 20); if(line.dist < 50) { line.dist = Math.max(pW, pH); line.angle = Math.random() * Math.PI * 2; }
            const x1 = cx + Math.cos(line.angle) * line.dist; const y1 = cy + Math.sin(line.angle) * line.dist;
            const x2 = cx + Math.cos(line.angle) * (line.dist + line.length); const y2 = cy + Math.sin(line.angle) * (line.dist + line.length);
            pCtx.moveTo(x1, y1); pCtx.lineTo(x2, y2);
        });
        pCtx.stroke();

        if (elapsed % 10 < 2) { 
            pCtx.fillStyle = 'rgba(0, 240, 255, 0.3)'; pCtx.font = 'bold 100px monospace'; pCtx.textAlign = 'center';
            pCtx.fillText(1990 + Math.floor(Math.random() * 35), Math.random() * pW, Math.random() * pH);
        }

        if (elapsed > VORTEX_DURATION - 1000) { pCtx.fillStyle = `rgba(255, 255, 255, ${(elapsed - (VORTEX_DURATION - 1000)) / 1000})`; pCtx.fillRect(0, 0, pW, pH); }
        vortexId = requestAnimationFrame(animateVortex);
    }

    function finishVortexAndStart() {
        cancelAnimationFrame(vortexId);
        const flash = document.getElementById('flash-overlay'); 
        const statusMsg = document.getElementById('status-message');
        
        statusMsg.innerText = "æ™‚ç©ºåŒæ­¥å®Œæˆ"; 
        flash.style.opacity = 1; 
        switchMusic(null);
        
        // æ ¸å¿ƒè·³è½‰é‚è¼¯
        setTimeout(() => {
             window.location.href = 'memory.html';
        }, 500);
    }

    function initBackgroundStars() {
        const bgLayer = document.getElementById('bg-layer'); const starCount = 100; 
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div'); const sizeRandom = Math.random();
            star.classList.add('bg-star', sizeRandom > 0.9 ? 'large' : sizeRandom > 0.6 ? 'medium' : 'small');
            star.style.left = Math.random() * 100 + '%'; star.style.top = Math.random() * 100 + '%';
            star.style.setProperty('--duration', (2 + Math.random() * 3) + 's'); star.style.animationDelay = (Math.random() * 5) + 's';
            bgLayer.appendChild(star);
        }
    }
    initBackgroundStars();
    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
    
    // æ³¨å…¥éœ‡å‹•å‹•ç•«æ¨£å¼
    const shakeStyle = document.createElement("style");
    shakeStyle.innerText = `@keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }`;
    document.head.appendChild(shakeStyle);
</script>
</body>

</html>



